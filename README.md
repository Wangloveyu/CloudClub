# Cloud Club

## 如何运行

1. 在本地启动ganache应用并创建工作空间。

2. 在 `./contracts` 中安装需要的依赖，运行如下的命令：
    ```bash
    npm install
    ```
    
3. 修改`./contracts/hardhat.config.ts`中的accounts为你本地ganache的工作空间中的私钥
   
    - 注意：如果url端口不一致的话也要修改
    
4. 修改完毕后在 `./contracts` 中编译并部署合约到ganache，运行如下的命令：

    ```bash
    npx hardhat run scripts/deploy.ts --network ganache
    ```

5. 部署完成之后将命令行中出现的两个地址分别复制到`./frontend/src/utils/contract-address.json`中的对应位置

6. 将部署完成后在`./contracts/artifacts/contracts`目录下产生的.json文件移动到`./frontend/src/utils/abis`文件夹下

    - 注意：==不是==`.dbg.json`文件

7. 在 `./frontend` 中安装需要的依赖，运行如下的命令

    - ```bash
        npm install
        ```

8. 在 `./frontend` 中启动前端程序，运行如下的命令：

    ```bash
    npm run start
    ```

## 功能实现分析

##### 实现的功能

项目完成的功能和具体实现方式如下：

- 每个学生初始可以拥有或领取一些通证积分（ERC20）。 
  - 项目要求用户在使用应用前必须先连接钱包，而在连接钱包的过程中，将会调用abi中的login接口，该接口会判断钱包地址是否曾经登录过，如果钱包地址是第一次登录则会创建用户信息，并给予用户100个初始通证积分
- 发起提案
  - 在用户登录后，点击发起提案按钮可以发起一个提案，用户可以在弹出的Modal中输入提案的内容和提案需要进行的时间(其他用户可以投票的时间)，当用户点击确认后，提案就会被发布，其他用户可以在提案列表中看见该提案，并表决该提案
    - 注意：该功能会消耗用户20 token，如果token不足则无法发起提案
- 提案自动更新并列表展示
  - 在提案发起后，其他用户可以在提案列表中看见被发起的提案及相关信息，并提供相关的赞同/反对功能
  - 由于智能合约无法被自动触发，因此提供了本地定时更新协议列表的功能，在更新完列表后重新获取到的协议列表才是最新的列表
    - 注意：此功能仅用于demo，实际使用时需要将更新提案列表功能架设在服务器上，本地仅保留获取提案列表功能，否则消耗太大
    - 注意：为了便于测试，自动获取提案的时间为每10s进行一次
- 赞同/反对提案
  - 用户可以点击相关提案中的赞同/反对按钮对提案进行表决
    - 注意：提案发起者==不能==对自己发起的提案进行投票
    - 注意：该功能会消耗用户5 token，如果token不足则无法发起投票
    - 注意：每个用户可以投的票数取决于其剩余的token数量，如果一个用户token数量足够，则可以进行无上限投票
      - 无上限投票设计的目的是为了奖励对于积极参与社团提案的人，积极参与的人在社团提案中应具有更高的话语权
- 获取提案通过奖励
  - 在提案投票时间截止后，赞成数大于反对数的提案会被通过，提案发起者作为贡献者可以领取一定的积分奖励，奖励的积分数量为发起提案消耗的token数+总票数*5
- (Bonus）发起提案并通过3次的学生，可以领取社团颁发的纪念品（ERC721）
  - 程序中，如果用户发起并通过的提案数大于3时，用户点击领取纪念品按钮可以领取一份纪念品，其返回值是一个token，该token与用户的地址进行绑定，该功能的实现方式采用了ERC721，其可以将token和用户地址直接绑定起来
    - 注意：该token仅会在第一次领取纪念品时出现，后续将不再出现，因此用户需要及时存储token
    - 注意：如果不符合领取要求将会出现相关的错误信息

##### 仅用于测试的功能

- 切换账户功能
  - 在本地进行测试时，由于提案发起者==不能==对自己发起的提案进行投票，因此提供了切换不同的账户的功能用于测试
    - 注意：使用该功能需要确保`./contracts/hardhat.config.ts`中的accounts数量不少于2个
- 领取通证积分功能
  - 在本地测试时，为了避免测试时出现通证积分不足的情况，因此提供了直接领取通证积分的功能，每次点击可以领取100通证积分

## 项目运行截图

放一些项目运行截图。

项目运行成功的关键页面和流程截图。主要包括操作流程以及和区块链交互的截图。



## 参考内容

课程的参考Demo见：[DEMOs](https://github.com/LBruyne/blockchain-course-demos)。

[web3.eth.Contract — web3.js 中文文档 — 登链社区 (learnblockchain.cn)](https://learnblockchain.cn/docs/web3.js/web3-eth-contract.html#events)

[node.js - web3.eth.subscribe未针对web3版本1.0.0-beta.27实现 - SO中文参考 - www.soinside.com](https://www.soinside.com/question/LR33hdhJQTh3WH7Z6JsUph)
